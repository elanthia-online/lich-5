name: Curate Pre Branch
# =============================================================================
# Orchestrates PR cherry-picking to prerelease branches with conflict resolution
#
# Features:
#   - Multiple conflict strategies (abort, ours, theirs, union)
#   - Squash or preserve commit history
#   - Dry-run mode for safe testing
#   - Syntax validation after auto-resolution
#   - Pluggable and testable architecture
#
# See: .github/scripts/curate-pre-branch.sh for implementation
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      destination:
        description: "Destination branch (auto-prefixed with pre/beta/)"
        required: true
        default: "pre/beta"
      base:
        description: "Base branch (must be main)"
        required: true
        default: "main"
      prs:
        description: "Comma-separated PR numbers (e.g., 12,27,43)"
        required: true
      mode:
        description: "auto | merged | head"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - merged
          - head
      squash:
        description: "Squash PRs into single commits?"
        required: true
        default: true
        type: boolean
      conflict_strategy:
        description: "Conflict resolution strategy"
        required: true
        default: "abort"
        type: choice
        options:
          - abort
          - ours
          - theirs
          - union
      reset_destination:
        description: "Force-recreate branch? (destroys history)"
        required: true
        default: false
        type: boolean
      dry_run:
        description: "Preview without pushing?"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: curate-${{ github.ref }}-${{ inputs.destination }}
  cancel-in-progress: true

jobs:
  curate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Install dependencies with pkg cache
        run: sudo apt-get update -y

      - name: Install jq
        uses: awalsh128/cache-apt-pkgs-action@acb598e5ddbc6f68a970c5da0688d2f3a9f04d05 # v1.6.0
        with:
          packages: jq
          version: 1.0

      - name: Curate pre-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DESTINATION: ${{ inputs.destination }}
          BASE: ${{ inputs.base }}
          PRS: ${{ inputs.prs }}
          MODE: ${{ inputs.mode }}
          SQUASH: ${{ inputs.squash }}
          CONFLICT_STRATEGY: ${{ inputs.conflict_strategy }}
          RESET_DESTINATION: ${{ inputs.reset_destination }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          chmod +x .github/scripts/curate-pre-branch.sh
          .github/scripts/curate-pre-branch.sh

      - name: Upload union merge audit artifacts
        if: ${{ always() && (env.HAD_CONFLICTS == 'true' || failure()) }}
        uses: actions/upload-artifact@v4
        with:
          name: union-merge-audit-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: ignore
          retention-days: 14
          path: |
            **/*.union-merge
            ${{ env.CONFLICT_LOG_FILE }}
            conflict-log*.md
            conflict-log*.txt
            .github/scripts/conflict-log*.md
            .github/scripts/conflict-log*.txt
